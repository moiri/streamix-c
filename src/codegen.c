#include "codegen.h"
#include <stdarg.h>
#include <stdio.h>

/******************************************************************************/
void cgen_box_create( int ident, int scope, int id, const char* name )
{
    cgen_ident( ident );
    cgen_print( "void* box_%d_%d = SMX_BOX_CREATE( %s );\n", id, scope,
            name );
}

/******************************************************************************/
void cgen_box_destroy( int ident, int scope, int id )
{
    cgen_ident( ident );
    cgen_print( "SMX_BOX_DESTROY( box_%d_%d );\n", id, scope );
}

/******************************************************************************/
void cgen_box_run( int ident, int scope, int id, const char* name )
{
    cgen_ident( ident );
    cgen_print( "SMX_BOX_RUN( box_%d_%d, %s );\n", id, scope, name );
}

/******************************************************************************/
void cgen_box_wait_end( int ident, const char* name )
{
    cgen_ident( ident );
    cgen_print( "SMX_BOX_WAIT_END( %s );\n", name );
}

/******************************************************************************/
void cgen_channel_create( int ident, int scope, int id )
{
    cgen_ident( ident );
    cgen_print( "void* ch_%d_%d = SMX_CHANNEL_CREATE();\n", id, scope );
}

/******************************************************************************/
void cgen_channel_destroy( int ident, int scope, int id )
{
    cgen_ident( ident );
    cgen_print( "SMX_CHANNEL_DESTROY( ch_%d_%d );\n", id, scope );
}

/******************************************************************************/
void cgen_connect( int ident, int scope, int id_ch, int id_box,
        const char* box_name, const char* ch_name )
{
    cgen_ident( ident );
    cgen_print( "SMX_CONNECT( box_%d_%d, ch_%d_%d, %s, %s );\n", id_box, scope,
            id_ch, scope, box_name, ch_name );
}

/******************************************************************************/
void cgen_function_end( int ident )
{
    cgen_ident( ident );
    cgen_print( "}\n\n" );
}

/******************************************************************************/
void cgen_header_c_file( const char* name )
{
  cgen_print( "/**\n" );
  cgen_print( " * @file %s.c\n\n", name );
  cgen_print( " * Source code of compiled streamix-file for runtime.\n\n" );
  cgen_print( " * THIS FILE HAS BEEN GENERATED.\n" );
  cgen_print( " * DO NOT EDIT THIS FILE.\n" );
  cgen_print( " * EDIT THE ORIGINAL STREAMIX-SOURCE FILE %s.smx INSTEAD!\n\n",
          name );
  cgen_print( " * ALL CHANGES MADE TO THIS FILE WILL BE OVERWRITTEN!\n" );
  cgen_print( " */\n\n" );
}

/******************************************************************************/
void cgen_ident( int ident )
{
    int i;
    for( i = 0; i < ident; i++ ) cgen_print( "    " );
}

/******************************************************************************/
void cgen_include_local( const char* file )
{
    cgen_print( "#include \"%s\"\n", file );
}

/******************************************************************************/
void cgen_main_head()
{
    cgen_print( "int main( void )\n{\n" );
}

/******************************************************************************/
int cgen_print( const char* format, ... )
{
    int res;
    va_list args;
    va_start( args, format );
    res = vprintf( format, args );
    va_end( args );
    return res;
}

/******************************************************************************/
void cgen_program_init( int ident )
{
    cgen_ident( ident );
    cgen_print( "SMX_PROGRAM_INIT();\n" );
}

/******************************************************************************/
void cgen_program_cleanup( int ident )
{
    cgen_ident( ident );
    cgen_print( "SMX_PROGRAM_CLEANUP();\n" );
}
